var C_MAXLEVELS=5,Main=function(a){a=void 0===a?null:a;Main._instance=this;this.oGame=null;this.iLevel=parseInt(location.hash.replace(/[\D]/,""));this.iLevel||(this.iLevel=1);0>=this.iLevel&&(this.iLevel=1);this.iLevel>=C_MAXLEVELS&&(this.iLevel=C_MAXLEVELS);this.oArea=new Area(Math.floor(Math.floor(window.innerWidth)/64)+3*this.iLevel,Math.floor(Math.floor(window.innerHeight)/64));this.oGraphic=new Graphic(this.oArea);this.iScore=0;this.iScoreTarget=200*this.iLevel;this.iHealth=100;this.iBombDamageBase=
10+2*this.iLevel;this.bPause=!1;this.bMusic=this.bSounds=!0;addEventListener("load",function(){var b=a?document.getElementById(a):null,c={type:Phaser.AUTO,width:b?b.clientWidth:window.innerWidth,height:b?b.clientWidth:window.innerHeight,physics:{"default":"arcade",arcade:{gravity:{y:200},debug:!1}},scene:{preload:this.fPreload,create:this.fCreate,update:this.fUpdate}};b&&(c.parent=a);this.oGame_what_is_this=new Phaser.Game(c)}.bind(this))};Main.getInstance=function(){return Main._instance};
Main.prototype.fPreload=function(){var a=Main.getInstance(),b=a.oGraphic,c=a.oArea;a.oGame=this;ButtonRetro.oGame=this;b.preload(this,c);this.load.audio("theme",["audio/level"+a.iLevel+".mp3"]);this.load.audioSprite("sfx",["audio/fx_mixdown.mp3"],"audio/fx_mixdown.json")};
Main.prototype.fCreate=function(){var a=this,b=Main.getInstance(),c=b.oGraphic,d=b.oArea;c.init(a);d.init(a,c);a.physics.add.overlap(d.oEnemies,d.oStars,b.collectStarByEnemy,null,b);a.physics.add.overlap(d.oPlayer,d.oStars,b.collectStarByPlayer,null,b);a.physics.add.overlap(d.oPlayer,d.oArmors,b.collectArmorByPlayer,null,b);a.physics.add.overlap(d.oEnemies,d.oArmors,b.collectArmorByEnemy,null,b);a.physics.add.overlap(d.oStars,d.oBombs,b.collectStarByBomb,null,b);a.physics.add.overlap(d.oArmors,d.oBombs,
b.collectArmorByBomb,null,b);a.physics.add.collider(d.oPlayer,d.oBombs,b.bombHit,null,b);a.input.on("pointerdown",function(a){});a.input.on("pointermove",function(a){});a.input.on("pointerup",function(a){});b.oCursors=a.input.keyboard.createCursorKeys();a.cameras.main.setBounds(-100,-100,c.sizeXpx+200,c.sizeYpx+200);a.cameras.main.startFollow(d.oPlayer);var e;new ButtonRetro({name:"pause",title:"PAUSE",scrollFactor:[0,0],scale:[1.6,2],x:c.screenWidth-140,y:c.screenHeight-50,text:{x:17,y:12,tint:11184810},
click:function(){b.bPause?(this.setText("PAUSE"),a.physics.resume(),this.oText.setTint(11184810),e&&b.oMusic.resume()):(this.setText("RESUME"),a.physics.pause(),this.oText.setTint(65280),e=b.oMusic.isPlaying,b.oMusic.pause());b.bPause=!b.bPause}});new ButtonRetro({name:"music",title:"MUSIC ON",scrollFactor:[0,0],scale:[2.3,2],x:16,y:c.screenHeight-50,text:{x:17,y:12,tint:65280},click:function(){b.oMusic.isPlaying?(this.setText("MUSIC OFF"),this.oText.setTint(11184810),b.oMusic.pause()):(this.setText("MUSIC ON"),
this.oText.setTint(65280),b.oMusic.resume())}});a.input.on("gameobjectover",function(a,b){ButtonRetro.oaCallbacks[b.name]&&(b.frame=b.scene.textures.getFrame(b.oConfig.sSpriteSheetName,0))});a.input.on("gameobjectout",function(a,b){ButtonRetro.oaCallbacks[b.name]&&(b.frame=b.scene.textures.getFrame(b.oConfig.sSpriteSheetName,1))});a.input.on("gameobjectdown",function(a,b){ButtonRetro.oaCallbacks[b.name]&&(b.frame=b.scene.textures.getFrame(b.oConfig.sSpriteSheetName,2))},this);a.input.on("gameobjectup",
function(a,b){ButtonRetro.oaCallbacks[b.name]&&(b.frame=b.scene.textures.getFrame(b.oConfig.sSpriteSheetName,0),ButtonRetro.oaCallbacks[b.name].fCallback.call(ButtonRetro.oaCallbacks[b.name].oInstance))});b.oScoreText=a.add.bitmapText(16,16,"font_retro","SCORE:0/"+b.iScoreTarget).setTint(16776960).setScrollFactor(0);b.oHealthText=a.add.bitmapText(c.screenWidth-220,16,"font_retro"," HEALTH:100%").setTint(16777215).setScrollFactor(0);var f=a.add.text(c.screenWidth05-80,3,"Level "+b.iLevel,{fontSize:"48px",
fontFamily:"Arial",fill:"rgb(255,255,0)"}).setScrollFactor(0);setTimeout(function(){f.destroy()},3E3);b.oMusic=a.sound.add("theme");b.music(b.bMusic)};
Main.prototype.fUpdate=function(){var a=Main.getInstance(),b=a.oArea;a.oCursors.left.isDown?(b.oPlayer.setVelocityX(Math.max(b.oPlayer.body.velocity.x-10,-200)),b.oPlayer.anims.play("left",!0)):a.oCursors.right.isDown?(b.oPlayer.setVelocityX(Math.min(b.oPlayer.body.velocity.x+10,200)),b.oPlayer.anims.play("right",!0)):(b.oPlayer.setVelocityX(0),b.oPlayer.anims.play("turn"));(b.oPlayer.body.onFloor()||b.oPlayer.body.touching.down)&&a.oCursors.up.isDown&&b.oPlayer.setVelocityY(-350);b.oEnemies.children.iterate(function(a){if(-10>
a.body.velocity.x)a.anims.play("enemy_left",!0);else if(10<a.body.velocity.x)a.anims.play("enemy_right",!0);else if(a.anims.play("enemy_turn",!0),.1>Math.random()&&(a.body.velocity.x=200*Math.random()-100,a.body.onFloor()||a.body.touching.down))a.body.velocity.y=100*(.5>Math.random()?1:-1)})};Main.prototype.getLevelNum=function(){return this.iLevel};
Main.prototype.collectStarByPlayer=function(a,b){b.disableBody(!0,!0);this.scoreChange(10);this.sound("boss hit");this.iScore>=this.iScoreTarget?this.iLevel==C_MAXLEVELS?(this.oGame.add.text(this.oGraphic.screenWidth05-150,this.oGraphic.screenHeight05,"VICTORY!!!",{fontSize:"64px",fontFamily:"Arial",fill:"#0a0"}).setScrollFactor(0),this.oMusic.stop(),this.oGame.physics.pause()):(this.oGame.add.text(this.oGraphic.screenWidth05-200,this.oGraphic.screenHeight05,"The level is won!",{fontSize:"64px",fontFamily:"Arial",
fill:"#ff0"}).setScrollFactor(0),this.oMusic.stop(),this.oGame.physics.pause(),setTimeout(function(){location.hash=this.iLevel+1;location.reload()}.bind(this),1E3)):this.checkStarsCount()};
Main.prototype.collectStarByEnemy=function(a,b){b.disableBody(!0,!0);var c=this.oArea.oBombs.create(a.body.position.x,a.body.position.y,"bomb");c.setBounce(1);c.setMass(.5);c.setCollideWorldBounds(!0);c.setVelocity(Phaser.Math.Between(-200,200),20);c.allowGravity=!1;var d=this.oGraphic.oParticles.createEmitter({speed:40,scale:{start:.05,end:.01},blendMode:"ADD"});d.startFollow(c);c._oEmitter=d;this.sound("squit");this.checkStarsCount()};
Main.prototype.checkStarsCount=function(){0===this.oArea.oStars.countActive(!0)&&(this.sound("escape"),setTimeout(this.restoreStarsAndArmors.call(this),1E3))};Main.prototype.restoreStarsAndArmors=function(){this.oArea.oStars.children.iterate(function(a){a.enableBody(!0,a.x,0,!0,!0)});this.oArea.oArmors.children.iterate(function(a){a.enableBody(!0,a.x,0,!0,!0)})};Main.prototype.collectStarByBomb=function(a,b){a.disableBody(!0,!0);this.bombDetonate(b);this.checkStarsCount()};
Main.prototype.collectArmorByPlayer=function(a,b){b.disableBody(!0,!0);this.sound("squit");this.healthChange(20)};Main.prototype.collectArmorByEnemy=function(a,b){b.disableBody(!0,!0);this.sound("squit")};Main.prototype.collectArmorByBomb=function(a,b){a.disableBody(!0,!0);this.bombDetonate(b)};
Main.prototype.bombHit=function(a,b){this.bombDetonate(b);this.scoreChange(-5);this.healthChange(-this.iBombDamageBase-Math.floor(Math.random()*this.iBombDamageBase+1));this.oArea.oPlayer.setTint(16711680);0>=this.iHealth?(this.oArea.oPlayer.anims.play("turn"),this.oGame.add.text(this.oGraphic.screenWidth05-150,this.oGraphic.screenHeight05,"GAME OVER",{fontSize:"64px",fontFamily:"Arial",fill:"#c00"}).setScrollFactor(0),this.sound("death"),this.oMusic.stop(),this.oGame.physics.pause(),setTimeout(function(){location.reload()},
3E3)):setTimeout(function(){this.oArea.oPlayer.clearTint()}.bind(this),1E3)};Main.prototype.healthChange=function(a){this.iHealth+=a;100<this.iHealth&&(this.iHealth=100);0>this.iHealth&&(this.iHealth=0);this.oHealthText.setText("HEALTH:"+this.iHealth+"%");99>=this.iHealth?(this.oHealthText.setTint(65280),60>=this.iHealth&&(this.oHealthText.setTint(16776960),40>=this.iHealth&&(this.oHealthText.setTint(16753920),20>=this.iHealth&&this.oHealthText.setTint(16711680)))):this.oHealthText.setTint(16777215)};
Main.prototype.scoreChange=function(a){this.iScore=Math.min(this.iScoreTarget,this.iScore+a);this.oScoreText.setText("SCORE:"+this.iScore+"/"+this.iScoreTarget);0==this.iScore?this.oScoreText.setTint(16777215):0>this.iScore?this.oScoreText.setTint(16711680):this.oScoreText.clearTint()};Main.prototype.bombDetonate=function(a){this.oGraphic.oParticles.emitters.remove(a._oEmitter);a.destroy();this.oGame.add.sprite(a.x,a.y,"detonate").anims.play("explode");this.sound("shot")};
Main.prototype.music=function(a){a?(this.oButtonMusicText&&this.oButtonMusicText.setText("MUSIC ON").setTint(65280),this.oMusic.isPaused?this.oMusic.resume():this.oMusic.play({loop:!0})):(this.oButtonMusicText&&this.oButtonMusicText.setText("MUSIC OFF").setTint(15658734),this.oMusic.pause())};Main.prototype.sound=function(a){this.bSounds&&this.oGame.sound.playAudioSprite("sfx",a)};
Main.prototype.printDebugInfo=function(a){var b=this.oGame.add.text(this.oGraphic.sizeXpx/2-this.oGraphic.wh05-150,this.oGraphic.screenHeight05,a,{fontSize:"24px",fontFamily:"Arial",fill:"rgb(255,255,255)"}).setScrollFactor(0);setTimeout(function(){b.destroy()},500)};
var Area=function(a,b){this.sizeX=a;this.sizeY=b;this.squareXY=a*b;this.aaLevelBlocks=[["titan_green","titan_gray"],["titan_yellow","titan_gray","steel900"],["titan_white","titan_gray","titan_ice","block_ice"],["titan_brown","titan_gray"],["titan_gray","steel900","standard400"]];this.aLevelBlocks=this.aaLevelBlocks[Main.getInstance().getLevelNum()-1];this.oHealthText=this.oScoreText=this.oCursors=this.oParticles=this.oBombs=this.oArmors=this.oStars=this.oPlayer=this.oEnemies=this.oElements=null;this.aaArea=
this.createEmptyArea()};
Area.prototype.init=function(a,b){this.oGame=a;this.oGraphic=b;this.oElements=this.createElements();this.oStars=this.createStars();this.oArmors=this.createArmors();this.oPlayer=this.createPlayer();this.oEnemies=this.createEnemies();this.oBombs=a.physics.add.group();a.physics.world.setBounds(0,0,b.sizeXpx,b.sizeYpx);a.physics.add.collider(this.oElements,this.oPlayer);a.physics.add.collider(this.oElements,this.oEnemies);a.physics.add.collider(this.oElements,this.oStars);a.physics.add.collider(this.oElements,this.oArmors);
a.physics.add.collider(this.oElements,this.oBombs);a.physics.add.collider(this.oEnemies,this.oPlayer);a.physics.add.collider(this.oEnemies,this.oBombs);a.physics.add.collider(this.oArmors,this.oStars);a.physics.add.collider(this.oEnemies,this.oEnemies);a.physics.add.collider(this.oBombs,this.oBombs);a.physics.add.collider(this.oStars,this.oStars);a.physics.add.collider(this.oArmors,this.oArmors)};Area.prototype.isEmpty=function(a,b){return!this.aaArea[a][b].element&&!this.aaArea[a][b].object};
Area.prototype.createEmptyArea=function(){for(var a=[],b=0;b<=this.sizeX;b++){for(var c=[],d=0;d<=this.sizeY;d++)c.push({element:null,object:null});a.push(c)}return a};
Area.prototype.createElements=function(){var a=this.oGame.physics.add.staticGroup(),b=Math.floor(this.squareXY/5);console.log("Area->createElements: qBlocks="+b);for(var c,d,e=0;e<b;e++)c=1+Math.floor(Math.random()*(this.sizeX-0)),d=1+Math.floor(Math.random()*(this.sizeY-1)),d%2&&d++,2>=d||(this.aaArea[c][d].element=this.aLevelBlocks[Math.floor(Math.random()*this.aLevelBlocks.length)]);for(c=1;c<=this.sizeX;c++)this.aaArea[c][1].element=this.aLevelBlocks[0],this.aaArea[c][this.sizeY].element=this.aLevelBlocks[0];
for(d=1;d<=this.sizeY;d++)this.aaArea[1][d].element=this.aLevelBlocks[0],this.aaArea[this.sizeX][d].element=this.aLevelBlocks[0];for(c=1;c<=this.sizeX;c++)for(d=1;d<=this.sizeY;d++)b=this.aaArea[c][d],b.element&&a.create(this.oGraphic.getPX(c),this.oGraphic.getPY(d),b.element);return a};
Area.prototype.createPlayer=function(){for(var a,b,c;;){c++;if(1E3<c)return alert("Error 1");a=1+Math.floor(Math.random()*this.sizeX);b=1+Math.floor(Math.random()*this.sizeY);if(this.isEmpty(a,b))break}this.aaArea[a][b].object="player";a=this.oGame.physics.add.sprite(this.oGraphic.getPX(a),this.oGraphic.getPX(b),"player").setVelocity(0,0).setMass(1.2).setBounce(.2).setCollideWorldBounds(!0);a.body.setGravityY(250);return a};
Area.prototype.createEnemies=function(){var a=this.oGame.physics.add.group({collideWorldBounds:!0,velocityX:100,velocityY:100,bounceX:1,bounceY:1}),b=Math.floor(this.squareXY/20);console.log("qEnemies="+b);for(var c=0;c<b;c++){for(var d,e,f=0;;){f++;if(1E3<f)return alert("Error 2");d=2+Math.floor(Math.random()*(this.sizeX-2));e=3+Math.floor(Math.random()*(this.sizeY-3));if(this.isEmpty(d,e))break}if(1E3<=f)break;this.aaArea[d][e].object="enemy";a.create(this.oGraphic.getPX(d),this.oGraphic.getPY(e),
"enemy")}return a};Area.prototype.createStars=function(){for(var a=this.oGame.physics.add.group({gravityY:50,collideWorldBounds:!0}),b=2;b<=this.sizeX-1;b++)this.isEmpty(b,2)?(this.aaArea[b][2].object="star",a.create(this.oGraphic.getPX(b),this.oGraphic.getPX(2),"star").setBounceY(Phaser.Math.FloatBetween(.4,.8))):console.error("Error 3");return a};
Area.prototype.createArmors=function(){var a=this.oGame.physics.add.group({gravityY:50,mass:.4,collideWorldBounds:!0}),b=Math.floor(this.squareXY/50);console.log("qArmors="+b);for(var c=0;c<b;c++){for(var d,e,f=0;;){f++;if(1E3<f)return alert("Error 4");d=2+Math.floor(Math.random()*(this.sizeX-2));e=3+Math.floor(Math.random()*(this.sizeY-3));if(this.isEmpty(d,e))break}if(1E3<=f)break;this.aaArea[d][e].object="armor";a.create(this.oGraphic.getPX(d),this.oGraphic.getPY(e),"armor").setBounceY(Phaser.Math.FloatBetween(.4,
.8))}return a};var Graphic=function(a){Graphic._instance=this;this.oArea=a;this.wh=64;this.wh05=this.wh/2;this.screenWidth=Math.floor(window.innerWidth);this.screenHeight=Math.floor(window.innerHeight);this.screenWidth05=this.screenWidth/2;this.screenHeight05=this.screenHeight/2;this.sizeXpx=a.sizeX*this.wh;this.sizeYpx=a.sizeY*this.wh};
Graphic.prototype.preload=function(a,b){a.load.setBaseURL("src");var c=a.add.graphics();a.load.on("progress",function(a){c.clear();c.fillStyle(170,1);c.fillRect(0,270,800*a,60)});a.load.on("complete",function(){c.destroy()});a.load.image("font_retro","img/fonts/16x16-blue-metal.png");a.load.spritesheet("button_custom","img/ui/flixel-button.png",{frameWidth:80,frameHeight:20});a.load.image("ground","img/sprites/"+["grass","sand","ice","dirt","asphalt"][Main.getInstance().getLevelNum()-1]+".png");for(var d=
0;d<this.oArea.aLevelBlocks.length;d++)a.load.image(b.aLevelBlocks[d],"img/sprites/"+b.aLevelBlocks[d]+".png");a.load.image("star","img/sprites/star.png");a.load.image("armor","img/sprites/armor25.png");a.load.image("bomb","img/sprites/bomb.png");a.load.image("particle_red","img/particles/yellow.png");a.load.spritesheet("enemy","img/sprites/enemy.png",{frameWidth:32,frameHeight:48});a.load.spritesheet("player","img/sprites/player.png",{frameWidth:32,frameHeight:48});a.load.spritesheet("detonate",
"img/sprites/explosion.png",{frameWidth:64,frameHeight:64,endFrame:23})};
Graphic.prototype.init=function(a){a.add.tileSprite(this.sizeXpx/2,this.sizeYpx/2,this.sizeXpx,this.sizeYpx,"ground");a.cache.bitmapFont.add("font_retro",Phaser.GameObjects.BitmapText.ParseRetroFont(a,{image:"font_retro",width:16,height:16,chars:"!\"#$%&'()*+,-./0123456789 ABCDEFGHIJKLMNOPQRSTUVWXYZ:",charsPerRow:20,spacing:{x:0,y:0}}));a.anims.create({key:"explode",frames:a.anims.generateFrameNumbers("detonate",{start:0,end:23,first:23}),frameRate:20});a.anims.create({key:"left",frames:a.anims.generateFrameNumbers("player",
{start:0,end:3}),frameRate:10,repeat:-1});a.anims.create({key:"turn",frames:[{key:"player",frame:4}],frameRate:20});a.anims.create({key:"right",frames:a.anims.generateFrameNumbers("player",{start:5,end:8}),frameRate:10,repeat:-1});a.anims.create({key:"enemy_left",frames:a.anims.generateFrameNumbers("enemy",{start:0,end:3}),frameRate:10,repeat:-1});a.anims.create({key:"enemy_turn",frames:[{key:"enemy",frame:4}],frameRate:20});a.anims.create({key:"enemy_right",frames:a.anims.generateFrameNumbers("enemy",
{start:5,end:8}),frameRate:10,repeat:-1});this.oParticles=a.add.particles("particle_red")};Graphic.prototype.getPX=function(a){return this.wh05+(a-1)*this.wh};Graphic.prototype.getPY=function(a){return this.wh05+(a-1)*this.wh};
var ButtonRetro=function(a){a=a||{};var b={},c=a.name?"":ButtonRetro.nextCounter();b.sName=a.name||"button"+c;ButtonRetro.oaCallbacks[b.sName]&&console.error('Error in ButtonRetro! name "'+b.sName+'" already use!');b.sTitle=a.title||"BUTTON"+c;b.sSpriteSheetName=a.spriteSheetName||"button_custom";b.oScrollFactor=a.scrollFactor||null;b.oScale=a.scale||null;b.x=a.x||0;b.y=a.y||0;b.frame=a.frame||0;b.oText={};c=a.text||{};b.oText.x=c.x||5;b.oText.y=c.y||5;b.oText.sFont=c.font||"font_retro";b.oText.iTint=
c.tint||null;c=ButtonRetro.oGame.add.image(b.x,b.y,b.sSpriteSheetName,b.frame).setOrigin(0,0).setInteractive().setName(b.sName);b.oScrollFactor&&c.setScrollFactor(b.oScrollFactor[0],b.oScrollFactor[1]);b.oScale&&c.setScale(b.oScale[0],b.oScale[1]);b.fClick=a.click||function(){console.warn("No callback function for button with name="+this.name+"!")}.bind(c);ButtonRetro.setCallback(this,b.sName,b.fClick);a=ButtonRetro.oGame.add.bitmapText(b.x+b.oText.x,b.y+b.oText.y,b.oText.sFont,b.sTitle).setOrigin(0,
0);null!==b.oText.iTint&&a.setTint(b.oText.iTint);b.oScrollFactor&&a.setScrollFactor(b.oScrollFactor[0],b.oScrollFactor[1]);c.oConfig=b;c.oText=a;this.oConfig=b;this.oButton=c;this.oText=a};ButtonRetro.prototype.setText=function(a){this.oText.setText(a)};ButtonRetro.setCallback=function(a,b,c){ButtonRetro.oaCallbacks[b]={oInstance:a,fCallback:c}};ButtonRetro.nextCounter=function(){return++ButtonRetro.iButton};ButtonRetro.oaCallbacks={};ButtonRetro.iButton=0;